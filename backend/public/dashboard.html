<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>My Dashboard ‚Äî Betopia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="/logo.png" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b0b12; color:#e8e6ff; }
    header { padding:20px; background:linear-gradient(90deg,#0b0b12,#1a1030 50%,#241245); border-bottom:1px solid #2a2151; }
    h1 { margin:0; font-size:22px; letter-spacing:0.3px; display:flex; align-items:center; gap:12px; }
    h1 img { height:32px; width:32px; }
    h2 { font-size:18px; margin:24px 0 12px; opacity:0.9; }
    #status { font-size:12px; opacity:0.8; margin-top:6px; }
    main { padding:20px; max-width: 1400px; margin: 0 auto; }
    
    /* Navigation */
    nav { display:flex; gap:12px; margin-top:16px; }
    nav a { 
      padding:8px 16px; border-radius:8px; background:#1a1030; 
      border:1px solid #2a2151; color:#e8e6ff; text-decoration:none; 
      font-size:14px; transition: all 0.2s;
    }
    nav a:hover { background:#241245; border-color:#5a4a9f; }
    nav a.active { background:#5a4a9f; border-color:#7a6abf; }
    
    /* Summary Cards */
    .summary-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:24px; }
    .kpi { background:#141426; border:1px solid #2a2151; border-radius:12px; padding:16px; text-align:center; }
    .kpi .label { font-size:11px; opacity:0.75; text-transform:uppercase; letter-spacing:0.5px; }
    .kpi .value { font-size:28px; font-weight:700; margin-top:8px; }
    .kpi .value.green { color:#2a914a; }
    .kpi .value.yellow { color:#a5972a; }
    .kpi .value.red { color:#b54949; }
    .kpi .subtext { font-size:12px; opacity:0.7; margin-top:6px; }
    
    /* Analytics Section */
    .analytics-section { background:#141426; border:1px solid #2a2151; border-radius:14px; padding:20px; margin-bottom:24px; }
    .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .section-title { font-size:16px; font-weight:600; opacity:0.9; }
    .btn-export { 
      padding:8px 16px; border-radius:8px; background:#5a4a9f; 
      border:1px solid #7a6abf; color:#fff; cursor:pointer; 
      font-size:13px; font-weight:600; transition: all 0.2s;
    }
    .btn-export:hover { background:#7a6abf; transform: scale(1.05); }
    
    /* Chart Container */
    .chart-container { position:relative; height:300px; margin-bottom:20px; }
    
    /* Performance Breakdown */
    .breakdown-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:16px; margin-top:20px; }
    .breakdown-card { background:#0b0b12; border:1px solid #2a2151; border-radius:10px; padding:16px; }
    .breakdown-title { font-size:13px; font-weight:600; opacity:0.8; margin-bottom:12px; text-transform:uppercase; letter-spacing:0.5px; }
    .breakdown-item { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #1a1a2e; }
    .breakdown-item:last-child { border-bottom:none; }
    .breakdown-label { font-size:13px; opacity:0.9; }
    .breakdown-stats { display:flex; gap:16px; font-size:12px; }
    .breakdown-stat { display:flex; flex-direction:column; align-items:flex-end; }
    .breakdown-stat-label { opacity:0.6; font-size:10px; }
    .breakdown-stat-value { font-weight:600; margin-top:2px; }
    .breakdown-stat-value.green { color:#2a914a; }
    .breakdown-stat-value.red { color:#b54949; }
    
    /* Filters */
    .filters { background:#141426; border:1px solid #2a2151; border-radius:14px; padding:16px; margin-bottom:20px; }
    .filter-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:12px; }
    .filter-group { display:flex; flex-direction:column; gap:6px; }
    .filter-group label { font-size:12px; opacity:0.8; font-weight:600; }
    .filter-group select, .filter-group input { 
      background:#0b0b12; border:1px solid #2a2151; border-radius:8px; 
      padding:8px 12px; color:#e8e6ff; font-size:14px;
    }
    .filter-group select:focus, .filter-group input:focus { outline:none; border-color:#5a4a9f; }
    
    /* View Toggle */
    .view-toggle { 
      display:flex; gap:8px; margin-bottom:20px; background:#141426; 
      border:1px solid #2a2151; border-radius:12px; padding:8px; width:fit-content;
    }
    .view-btn { 
      padding:8px 16px; border-radius:8px; background:transparent; 
      border:1px solid transparent; color:#e8e6ff; cursor:pointer; 
      font-size:14px; font-weight:600; transition: all 0.2s;
    }
    .view-btn:hover { background:#1a1030; }
    .view-btn.active { background:#5a4a9f; border-color:#7a6abf; }
    
    /* Timeline View */
    .timeline-container { position:relative; }
    .timeline-date-group { margin-bottom:32px; position:relative; }
    .timeline-date-header { 
      position:sticky; top:0; z-index:10; background:#0b0b12; 
      padding:12px 0; margin-bottom:16px; border-bottom:2px solid #5a4a9f;
      display:flex; align-items:center; gap:12px;
    }
    .timeline-date-badge { 
      background:#5a4a9f; color:#fff; padding:6px 12px; 
      border-radius:999px; font-size:13px; font-weight:600;
      display:inline-flex; align-items:center; gap:6px;
    }
    .timeline-date-label { font-size:16px; font-weight:600; }
    .timeline-bet-count { font-size:12px; opacity:0.7; margin-left:auto; }
    
    .timeline-line { 
      position:absolute; left:20px; top:60px; bottom:0; 
      width:2px; background:linear-gradient(180deg, #5a4a9f, transparent);
    }
    
    .timeline-bets { display:flex; flex-direction:column; gap:12px; padding-left:48px; }
    
    .timeline-card { 
      background:#141426; border:1px solid #2a2151; border-radius:12px; 
      padding:14px; transition: all 0.2s; position:relative;
    }
    .timeline-card::before {
      content:''; position:absolute; left:-36px; top:20px;
      width:12px; height:12px; border-radius:50%;
      background:#5a4a9f; border:3px solid #0b0b12;
    }
    .timeline-card:hover { border-color:#5a4a9f; transform: translateX(4px); }
    
    .timeline-card-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px; }
    .timeline-teams { font-size:15px; font-weight:600; }
    .timeline-time { font-size:11px; opacity:0.6; margin-top:4px; }
    
    .timeline-bet-info { display:flex; gap:16px; flex-wrap:wrap; font-size:13px; margin-top:8px; }
    .timeline-bet-info span { display:flex; align-items:center; gap:6px; opacity:0.9; }
    
    /* Bet Cards (List View) */
    .card { background:#141426; border:1px solid #2a2151; border-radius:14px; padding:18px; margin-bottom:14px; transition: all 0.2s; position:relative; }
    .card:hover { border-color:#5a4a9f; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(90,74,159,0.2); }
    .card-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; }
    .match-info { flex:1; }
    .teams { font-size:16px; font-weight:600; margin-bottom:6px; }
    .league-badge { display:inline-flex; align-items:center; gap:6px; font-size:12px; opacity:0.8; }
    .kickoff { font-size:12px; opacity:0.7; margin-top:4px; }
    
    .status-badge { 
      padding:6px 12px; border-radius:999px; font-size:12px; font-weight:600;
      display:inline-flex; align-items:center; gap:6px;
    }
    .status-badge.pending { background:#322d10; border:1px solid #a5972a; color:#a5972a; }
    .status-badge.won { background:#11311f; border:1px solid #2a914a; color:#2a914a; }
    .status-badge.lost { background:#381313; border:1px solid #b54949; color:#b54949; }
    .status-badge.void { background:#1a1a2e; border:1px solid #4a4a6a; color:#8a8aaa; }
    
    .bet-details { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px; margin:12px 0; }
    .detail-item { background:#0b0b12; border:1px solid #2a2151; border-radius:8px; padding:10px; }
    .detail-label { font-size:11px; opacity:0.7; text-transform:uppercase; letter-spacing:0.5px; }
    .detail-value { font-size:16px; font-weight:600; margin-top:4px; }
    
    .card-footer { display:flex; justify-content:space-between; align-items:center; margin-top:12px; padding-top:12px; border-top:1px solid #2a2151; }
    .added-date { font-size:11px; opacity:0.6; }
    
    .btn-remove { 
      padding:6px 12px; border-radius:6px; background:#381313; 
      border:1px solid #b54949; color:#b54949; cursor:pointer; 
      font-size:12px; font-weight:600; transition: all 0.2s;
    }
    .btn-remove:hover { background:#4a1a1a; transform: scale(1.05); }
    
    .empty-state { text-align:center; padding:80px 20px; opacity:0.6; }
    .empty-state svg { width:100px; height:100px; opacity:0.3; margin-bottom:20px; }
    .empty-state h3 { font-size:20px; margin-bottom:12px; }
    .empty-state p { font-size:14px; margin-bottom:24px; }
    .empty-state a { 
      display:inline-block; padding:10px 20px; border-radius:8px; 
      background:#5a4a9f; border:1px solid #7a6abf; color:#fff; 
      text-decoration:none; font-weight:600; transition: all 0.2s;
    }
    .empty-state a:hover { background:#7a6abf; transform: scale(1.05); }
    
    .muted { opacity:0.7; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <header>
    <h1><img src="/logo.png" alt="Betopia" /> üìä My Dashboard ‚Äî Betopia</h1>
    <nav>
      <a href="/">Smart Bets</a>
      <a href="/dashboard.html" class="active">My Dashboard</a>
      <a href="/fixtures.html">Fixtures</a>
    </nav>
    <div id="status" class="muted">Loading your saved bets...</div>
  </header>

  <main>
    <!-- Summary KPIs -->
    <div class="summary-grid">
      <div class="kpi">
        <div class="label">Total Bets</div>
        <div class="value" id="total-bets">0</div>
      </div>
      <div class="kpi">
        <div class="label">Pending</div>
        <div class="value yellow" id="pending-bets">0</div>
      </div>
      <div class="kpi">
        <div class="label">Won</div>
        <div class="value green" id="won-bets">0</div>
      </div>
      <div class="kpi">
        <div class="label">Lost</div>
        <div class="value red" id="lost-bets">0</div>
      </div>
      <div class="kpi">
        <div class="label">Win Rate</div>
        <div class="value" id="win-rate">0%</div>
        <div class="subtext">of settled bets</div>
      </div>
      <div class="kpi">
        <div class="label">Total P/L</div>
        <div class="value" id="total-pl">¬£0.00</div>
        <div class="subtext">ROI: <span id="roi">0%</span></div>
      </div>
    </div>

    <!-- P/L Analytics -->
    <div class="analytics-section">
      <div class="section-header">
        <h2 class="section-title">üìà Profit/Loss Analytics</h2>
        <button class="btn-export" onclick="exportToCSV()">üì• Export CSV</button>
      </div>
      
      <div class="chart-container">
        <canvas id="plChart"></canvas>
      </div>

      <!-- Performance Breakdown -->
      <div class="breakdown-grid">
        <div class="breakdown-card">
          <div class="breakdown-title">üèÜ By League</div>
          <div id="breakdown-league"></div>
        </div>
        <div class="breakdown-card">
          <div class="breakdown-title">üìä By Market</div>
          <div id="breakdown-market"></div>
        </div>
        <div class="breakdown-card">
          <div class="breakdown-title">üéØ By Confidence</div>
          <div id="breakdown-confidence"></div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="filter-grid">
        <div class="filter-group">
          <label>Status</label>
          <select id="filter-status">
            <option value="all">All Bets</option>
            <option value="pending">Pending</option>
            <option value="won">Won</option>
            <option value="lost">Lost</option>
            <option value="void">Void</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Market</label>
          <select id="filter-market">
            <option value="all">All Markets</option>
            <option value="Over/Under">Over/Under</option>
            <option value="BTTS">BTTS</option>
            <option value="1X2">1X2</option>
            <option value="Asian Handicap">Asian Handicap</option>
            <option value="Double Chance">Double Chance</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Date From</label>
          <input type="date" id="filter-date-from" />
        </div>
        <div class="filter-group">
          <label>Date To</label>
          <input type="date" id="filter-date-to" />
        </div>
        <div class="filter-group">
          <label>Sort By</label>
          <select id="sort-by">
            <option value="date-desc">Newest First</option>
            <option value="date-asc">Oldest First</option>
            <option value="odds-desc">Highest Odds</option>
            <option value="odds-asc">Lowest Odds</option>
          </select>
        </div>
      </div>
    </div>

    <!-- View Toggle -->
    <div class="view-toggle">
      <button class="view-btn active" data-view="list" onclick="toggleView('list')">üìã List View</button>
      <button class="view-btn" data-view="timeline" onclick="toggleView('timeline')">üìÖ Timeline View</button>
    </div>

    <!-- Saved Bets List -->
    <h2>üìã My Saved Bets</h2>
    <div id="bets-container"></div>
  </main>

  <script>
    // LocalStorage key
    const STORAGE_KEY = 'fbb_saved_bets';
    let plChart = null;
    let currentView = 'list';

    // Load saved bets from localStorage
    function loadSavedBets() {
      const stored = localStorage.getItem(STORAGE_KEY);
      return stored ? JSON.parse(stored) : [];
    }

    // Save bets to localStorage
    function saveBets(bets) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(bets));
    }

    // Remove a bet
    function removeBet(betId) {
      const bets = loadSavedBets();
      const filtered = bets.filter(b => b.id !== betId);
      saveBets(filtered);
      renderDashboard();
    }

    // Calculate summary stats
    function calculateStats(bets) {
      const total = bets.length;
      const pending = bets.filter(b => b.status === 'pending').length;
      const won = bets.filter(b => b.status === 'won').length;
      const lost = bets.filter(b => b.status === 'lost').length;
      const settled = won + lost;
      const winRate = settled > 0 ? ((won / settled) * 100).toFixed(1) : 0;
      
      // Calculate P/L (assuming ¬£10 stake per bet for demo)
      const stake = 10;
      let totalPL = 0;
      bets.forEach(bet => {
        if (bet.status === 'won') {
          totalPL += (bet.odds - 1) * stake;
        } else if (bet.status === 'lost') {
          totalPL -= stake;
        }
      });
      
      const totalStaked = settled * stake;
      const roi = totalStaked > 0 ? ((totalPL / totalStaked) * 100).toFixed(1) : 0;
      
      return { total, pending, won, lost, winRate, totalPL, roi };
    }

    // Render summary KPIs
    function renderSummary(stats) {
      document.getElementById('total-bets').textContent = stats.total;
      document.getElementById('pending-bets').textContent = stats.pending;
      document.getElementById('won-bets').textContent = stats.won;
      document.getElementById('lost-bets').textContent = stats.lost;
      document.getElementById('win-rate').textContent = `${stats.winRate}%`;
      
      const plEl = document.getElementById('total-pl');
      plEl.textContent = `¬£${stats.totalPL.toFixed(2)}`;
      plEl.className = 'value ' + (stats.totalPL > 0 ? 'green' : stats.totalPL < 0 ? 'red' : '');
      
      const roiEl = document.getElementById('roi');
      roiEl.textContent = `${stats.roi}%`;
      roiEl.style.color = stats.roi > 0 ? '#2a914a' : stats.roi < 0 ? '#b54949' : '';
    }

    // Render P/L Chart
    function renderPLChart(bets) {
      const settledBets = bets.filter(b => b.status === 'won' || b.status === 'lost')
        .sort((a, b) => new Date(a.addedAt) - new Date(b.addedAt));
      
      const stake = 10;
      let cumulativePL = 0;
      const chartData = settledBets.map(bet => {
        if (bet.status === 'won') {
          cumulativePL += (bet.odds - 1) * stake;
        } else {
          cumulativePL -= stake;
        }
        return {
          x: new Date(bet.addedAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }),
          y: cumulativePL
        };
      });

      const ctx = document.getElementById('plChart');
      if (plChart) plChart.destroy();

      plChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: chartData.map(d => d.x),
          datasets: [{
            label: 'Cumulative P/L (¬£)',
            data: chartData.map(d => d.y),
            borderColor: cumulativePL >= 0 ? '#2a914a' : '#b54949',
            backgroundColor: cumulativePL >= 0 ? 'rgba(42, 145, 74, 0.1)' : 'rgba(181, 73, 73, 0.1)',
            tension: 0.4,
            fill: true,
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#141426',
              titleColor: '#e8e6ff',
              bodyColor: '#e8e6ff',
              borderColor: '#2a2151',
              borderWidth: 1,
              padding: 12,
              displayColors: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#2a2151' },
              ticks: { 
                color: '#e8e6ff',
                callback: value => `¬£${value.toFixed(0)}`
              }
            },
            x: {
              grid: { color: '#2a2151' },
              ticks: { color: '#e8e6ff' }
            }
          }
        }
      });
    }

    // Calculate breakdown stats
    function calculateBreakdown(bets, groupBy) {
      const stake = 10;
      const groups = {};
      
      bets.forEach(bet => {
        const key = bet[groupBy] || 'Unknown';
        if (!groups[key]) {
          groups[key] = { total: 0, won: 0, lost: 0, pl: 0 };
        }
        groups[key].total++;
        if (bet.status === 'won') {
          groups[key].won++;
          groups[key].pl += (bet.odds - 1) * stake;
        } else if (bet.status === 'lost') {
          groups[key].lost++;
          groups[key].pl -= stake;
        }
      });

      return Object.entries(groups)
        .map(([name, stats]) => ({
          name,
          ...stats,
          winRate: stats.won + stats.lost > 0 ? ((stats.won / (stats.won + stats.lost)) * 100).toFixed(1) : 0
        }))
        .sort((a, b) => b.pl - a.pl);
    }

    // Render breakdown section
    function renderBreakdown(bets) {
      const leagues = calculateBreakdown(bets, 'league');
      const markets = calculateBreakdown(bets, 'market');
      
      // Confidence breakdown (extract from probability)
      const confidenceBets = bets.map(b => ({
        ...b,
        confidence: b.probability >= 0.65 ? 'High (‚â•65%)' : b.probability >= 0.55 ? 'Medium (55-64%)' : 'Low (<55%)'
      }));
      const confidence = calculateBreakdown(confidenceBets, 'confidence');

      document.getElementById('breakdown-league').innerHTML = leagues.slice(0, 5).map(item => `
        <div class="breakdown-item">
          <span class="breakdown-label">${item.name}</span>
          <div class="breakdown-stats">
            <div class="breakdown-stat">
              <span class="breakdown-stat-label">W/L</span>
              <span class="breakdown-stat-value">${item.won}/${item.lost}</span>
            </div>
            <div class="breakdown-stat">
              <span class="breakdown-stat-label">Win%</span>
              <span class="breakdown-stat-value">${item.winRate}%</span>
            </div>
            <div class="breakdown-stat">
              <span class="breakdown-stat-label">P/L</span>
              <span class="breakdown-stat-value ${item.pl >= 0 ? 'green' : 'red'}">¬£${item.pl.toFixed(2)}</span>
            </div>
          </div>
        </div>
      `).join('') || '<div style="opacity:0.6; text-align:center; padding:20px;">No data</div>';

      document.getElementById('breakdown-market').innerHTML = markets.map(item => `
        <div class="breakdown-item">
          <span class="breakdown-label">${item.name}</span>
          <div class="breakdown-stats">
            <div class="breakdown-stat">
              <span class="breakdown-stat-label">W/L</span>
              <span class="breakdown-stat-value">${item.won}/${item.lost}</span>
            </div>
            <div class="breakdown-stat">
              <span class="breakdown-stat-label">Win%</span>
              <span class="breakdown-stat-value">${item.winRate}%</span>
            </div>
            <div class="breakdown-stat">
              <span class="breakdown-stat-label">P/L</span>
              <span class="breakdown-stat-value ${item.pl >= 0 ? 'green' : 'red'}">¬£${item.pl.toFixed(2)}</span>
            </div>
          </div>
        </div>
      `).join('') || '<div style="opacity:0.6; text-align:center; padding:20px;">No data</div>';

      document.getElementById('breakdown-confidence').innerHTML = confidence.map(item => `
        <div class="breakdown-item">
          <span class="breakdown-label">${item.name}</span>
          <div class="breakdown-stats">
            <div class="breakdown-stat">
              <span class="breakdown-stat-label">W/L</span>
              <span class="breakdown-stat-value">${item.won}/${item.lost}</span>
            </div>
            <div class="breakdown-stat">
              <span class="breakdown-stat-label">Win%</span>
              <span class="breakdown-stat-value">${item.winRate}%</span>
            </div>
            <div class="breakdown-stat">
              <span class="breakdown-stat-label">P/L</span>
              <span class="breakdown-stat-value ${item.pl >= 0 ? 'green' : 'red'}">¬£${item.pl.toFixed(2)}</span>
            </div>
          </div>
        </div>
      `).join('') || '<div style="opacity:0.6; text-align:center; padding:20px;">No data</div>';
    }

    // Export to CSV
    function exportToCSV() {
      const bets = loadSavedBets();
      if (bets.length === 0) {
        alert('No bets to export');
        return;
      }

      const headers = ['Date Added', 'Kickoff', 'League', 'Home Team', 'Away Team', 'Market', 'Selection', 'Odds', 'Probability', 'Status', 'P/L'];
      const stake = 10;
      
      const rows = bets.map(bet => {
        let pl = 0;
        if (bet.status === 'won') pl = (bet.odds - 1) * stake;
        else if (bet.status === 'lost') pl = -stake;
        
        return [
          new Date(bet.addedAt).toLocaleDateString('en-GB'),
          new Date(bet.kickoff).toLocaleString('en-GB'),
          bet.league,
          bet.homeTeam,
          bet.awayTeam,
          bet.market,
          bet.selection,
          bet.odds.toFixed(2),
          (bet.probability * 100).toFixed(1) + '%',
          bet.status,
          '¬£' + pl.toFixed(2)
        ];
      });

      const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `betopia-bets-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Get date label (Today, Yesterday, etc.)
    function getDateLabel(date) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const betDate = new Date(date);
      betDate.setHours(0, 0, 0, 0);
      
      const diffDays = Math.floor((today - betDate) / (1000 * 60 * 60 * 24));
      
      if (diffDays === 0) return 'Today';
      if (diffDays === 1) return 'Yesterday';
      if (diffDays < 7) return betDate.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'short' });
      return betDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    // Group bets by date
    function groupBetsByDate(bets) {
      const groups = {};
      
      bets.forEach(bet => {
        const dateKey = new Date(bet.addedAt).toDateString();
        if (!groups[dateKey]) {
          groups[dateKey] = [];
        }
        groups[dateKey].push(bet);
      });

      return Object.entries(groups)
        .map(([dateKey, bets]) => ({
          date: new Date(dateKey),
          dateKey,
          label: getDateLabel(dateKey),
          bets,
          count: bets.length
        }))
        .sort((a, b) => b.date - a.date);
    }

    // Render timeline card
    function renderTimelineCard(bet) {
      const statusEmoji = {
        pending: '‚è≥',
        won: '‚úÖ',
        lost: '‚ùå',
        void: '‚ö™'
      };

      return `
        <div class="timeline-card">
          <div class="timeline-card-header">
            <div>
              <div class="timeline-teams">${bet.homeTeam} vs ${bet.awayTeam}</div>
              <div class="timeline-time">‚è∞ ${new Date(bet.kickoff).toLocaleString('en-GB', { 
                hour: '2-digit', minute: '2-digit' 
              })}</div>
            </div>
            <span class="status-badge ${bet.status}">
              ${statusEmoji[bet.status]} ${bet.status.toUpperCase()}
            </span>
          </div>
          <div class="timeline-bet-info">
            <span>üèÜ ${bet.league}</span>
            <span>üìä ${bet.market}</span>
            <span>üéØ ${bet.selection}</span>
            <span>üí∞ ${bet.odds.toFixed(2)}</span>
            <span>üìà ${(bet.probability * 100).toFixed(1)}%</span>
          </div>
          <div style="margin-top:10px; display:flex; justify-content:flex-end;">
            <button class="btn-remove" onclick="removeBet('${bet.id}')">üóëÔ∏è Remove</button>
          </div>
        </div>
      `;
    }

    // Render timeline view
    function renderTimelineView(bets) {
      const groups = groupBetsByDate(bets);
      
      if (groups.length === 0) {
        return `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11l3 3L22 4"></path>
              <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
            </svg>
            <h3>No Bets Match Filters</h3>
            <p>Try adjusting your filters to see more bets.</p>
          </div>
        `;
      }

      return `
        <div class="timeline-container">
          ${groups.map(group => `
            <div class="timeline-date-group">
              <div class="timeline-date-header">
                <span class="timeline-date-badge">üìÖ ${group.label}</span>
                <span class="timeline-date-label">${group.date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}</span>
                <span class="timeline-bet-count">${group.count} bet${group.count !== 1 ? 's' : ''}</span>
              </div>
              <div class="timeline-line"></div>
              <div class="timeline-bets">
                ${group.bets.map(renderTimelineCard).join('')}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Render bet card (list view)
    function renderBetCard(bet) {
      const statusEmoji = {
        pending: '‚è≥',
        won: '‚úÖ',
        lost: '‚ùå',
        void: '‚ö™'
      };

      return `
        <div class="card">
          <div class="card-header">
            <div class="match-info">
              <div class="teams">${bet.homeTeam} vs ${bet.awayTeam}</div>
              <div class="league-badge">üèÜ ${bet.league}</div>
              <div class="kickoff">‚è∞ ${new Date(bet.kickoff).toLocaleString('en-GB', { 
                weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' 
              })}</div>
            </div>
            <span class="status-badge ${bet.status}">
              ${statusEmoji[bet.status]} ${bet.status.toUpperCase()}
            </span>
          </div>

          <div class="bet-details">
            <div class="detail-item">
              <div class="detail-label">Market</div>
              <div class="detail-value">${bet.market}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Selection</div>
              <div class="detail-value">${bet.selection}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Odds</div>
              <div class="detail-value">${bet.odds.toFixed(2)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Probability</div>
              <div class="detail-value">${(bet.probability * 100).toFixed(1)}%</div>
            </div>
          </div>

          <div class="card-footer">
            <span class="added-date">Added: ${new Date(bet.addedAt).toLocaleDateString('en-GB')}</span>
            <button class="btn-remove" onclick="removeBet('${bet.id}')">üóëÔ∏è Remove</button>
          </div>
        </div>
      `;
    }

    // Toggle view
    function toggleView(view) {
      currentView = view;
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      renderDashboard();
    }

    // Apply filters and sorting
    function filterAndSortBets(bets) {
      const statusFilter = document.getElementById('filter-status').value;
      const marketFilter = document.getElementById('filter-market').value;
      const dateFrom = document.getElementById('filter-date-from').value;
      const dateTo = document.getElementById('filter-date-to').value;
      const sortBy = document.getElementById('sort-by').value;

      // Filter
      let filtered = bets;
      if (statusFilter !== 'all') {
        filtered = filtered.filter(b => b.status === statusFilter);
      }
      if (marketFilter !== 'all') {
        filtered = filtered.filter(b => b.market === marketFilter);
      }
      if (dateFrom) {
        filtered = filtered.filter(b => new Date(b.addedAt) >= new Date(dateFrom));
      }
      if (dateTo) {
        const endDate = new Date(dateTo);
        endDate.setHours(23, 59, 59, 999);
        filtered = filtered.filter(b => new Date(b.addedAt) <= endDate);
      }

      // Sort
      filtered.sort((a, b) => {
        switch(sortBy) {
          case 'date-desc': return new Date(b.addedAt) - new Date(a.addedAt);
          case 'date-asc': return new Date(a.addedAt) - new Date(b.addedAt);
          case 'odds-desc': return b.odds - a.odds;
          case 'odds-asc': return a.odds - b.odds;
          default: return 0;
        }
      });

      return filtered;
    }

    // Render dashboard
    function renderDashboard() {
      const allBets = loadSavedBets();
      const stats = calculateStats(allBets);
      renderSummary(stats);
      renderPLChart(allBets);
      renderBreakdown(allBets);

      const filteredBets = filterAndSortBets(allBets);
      const container = document.getElementById('bets-container');

      if (filteredBets.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11l3 3L22 4"></path>
              <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
            </svg>
            <h3>${allBets.length === 0 ? 'No Saved Bets Yet' : 'No Bets Match Filters'}</h3>
            <p>${allBets.length === 0 ? 'Start adding bets from the Smart Bets page to track them here.' : 'Try adjusting your filters to see more bets.'}</p>
            ${allBets.length === 0 ? '<a href="/">Browse Smart Bets</a>' : ''}
          </div>
        `;
      } else {
        if (currentView === 'timeline') {
          container.innerHTML = renderTimelineView(filteredBets);
        } else {
          container.innerHTML = filteredBets.map(renderBetCard).join('');
        }
      }

      document.getElementById('status').textContent = `${filteredBets.length} bet${filteredBets.length !== 1 ? 's' : ''} displayed`;
    }

    // Event listeners
    document.getElementById('filter-status').addEventListener('change', renderDashboard);
    document.getElementById('filter-market').addEventListener('change', renderDashboard);
    document.getElementById('filter-date-from').addEventListener('change', renderDashboard);
    document.getElementById('filter-date-to').addEventListener('change', renderDashboard);
    document.getElementById('sort-by').addEventListener('change', renderDashboard);

    // Initial render
    renderDashboard();
  </script>
</body>
</html>
